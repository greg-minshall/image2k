## dyn.load("rimage2k.dylib");

my.pixmapRGB = function(matrixR, matrixG, matrixB, ...)
{
  entry <- Sys.time();

  if ((!all(dim(matrixR) == dim(matrixG))) ||
      (!all(dim(matrixG) == dim(matrixB)))) {
    stop("R, G, and B matrices must be of the same size");
  }

  print("about to call new..pixmap");
  when <- Sys.time();
  z = new("pixmapRGB", pixmap(matrixR, ...));
  print(Sys.time()-when);

  print("about to max/min");
  when <- Sys.time();

  datamax <- max(matrixR, matrixG, matrixB);
  datamin <- min(matrixR, matrixG, matrixB);

  print(Sys.time()-when);

#  print("about to as.numeric");
#  matrixR <- as.numeric(matrixR);
#  matrixG <- as.numeric(matrixG);
#  matrixB <- as.numeric(matrixB);
  if(datamax>1 || datamin<0) {
    print("about to normalize");
    matrixR <- (matrixR - datamin)/(datamax-datamin);
    matrixG <- (matrixG - datamin)/(datamax-datamin);
    matrixB <- (matrixB - datamin)/(datamax-datamin);
  }

  print("assigning matrices");
  when <- Sys.time();

  z@red = matrixR;
  z@green = matrixG;
  z@blue = matrixB;

  print(Sys.time()-when);

  print("internal time"); print(Sys.time()-entry);
  z
}

## with the default parameters with.imlib2=TRUE, with.magick=TRUE, it
## is implementation dependent which library will be used for a given
## image.
read.image2k <- function(file, with.imlib2=TRUE, with.magickwand=TRUE, ...) {
  if (!(with.imlib2 || with.magickwand)) {
    stop("read.image2k: can't turn off *both* with.imlib2 *and* with.magickwand");
  }

  if (@have_imlib2@ && @have_magickwand@) {
    if (with.imlib2 && with.magickwand) {
      usemagickwand = FALSE;            # XXX default, sort of
    } else if (with.imlib2) {
      usemagickwand = FALSE;
    } else if (with.magickwand) {
      usemagickwand = TRUE;
    }
  } else if (@have_imlib2@) {
    if (with.imlib2) {
      usemagickwand = FALSE;
    } else {
      stop("read.image2k: with_imlib=FALSE: no magickwand, so with.imlib2 can only be true");
    }
  } else if (@have_magickwand@) {
    if (with.magickwand) {
      usemagickwand = TRUE;
    } else {
      stop("read.image2k: with.magick=FALSE: no magickwand, so with.imlib2 can only be true");
    }
  } else {
    stop("read.image2k: should not occur: neither Imlib2 nor MagickWand available (so, initial install should have failed)");
  }

  print("about to call rimageread");
  when <- Sys.time();

  im2k <- .External("rimageread", file, usemagickwand=usemagickwand);

  print(Sys.time()-when);

  print("about to call myrgb");
  when <- Sys.time();

  pm <- my.pixmapRGB(matrix(im2k$red, nrow=im2k$nr),
              matrix(im2k$green, nrow=im2k$nr),
              matrix(im2k$blue, nrow=im2k$nr));

  print(Sys.time()-when);

  pm;
}

write.image2k <- function(file, pmap, with.imlib2=TRUE, with.magickwand=TRUE) {
}
